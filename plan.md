# 実装計画: 中心抽出（CSV座標周辺）の効率化と共通化

## 1. 中心抽出の効率化の仕組み（現状の実装）

中心抽出（単点CSV処理：CSV座標周辺の点を抽出）には、1GB超のファイルでも効率的に処理できる仕組みが備わっている。

### 閾値とモード切り替え

- ファイルサイズが **300MB を超える**とストリーミングモードに切り替わる。
- 参照: `app_github_pages.js` の `STREAMING_THRESHOLD_MB = 300`（約9行目）、`DEFAULT_CHUNK_SIZE_MB = 100`（約13行目）。

### 非圧縮LAS（300MB超）

- ヘッダーだけ先に読み、点データは `file.slice(currentOffset, currentOffset + chunkSize)` で**チャンク単位**（デフォルト100MB）に読み込む。
- 各チャンクをパースし、中心距離でフィルタし、**マッチした点だけ** `filteredPoints` に追加する。
- 常に「ヘッダー + 1チャンク分」程度のメモリしか持たないため、1GB超のLASでもメモリ効率が良い。
- 実装: `processLASStreaming(lazFile, header, centers, radius, ...)`（約1416行目）。

### 圧縮LAZ（300MB超）

- 解凍は **1点ずつ** `laszip.getPoint(pointPtr)` で行い、その場でフィルタし、マッチした点だけ `filteredPoints` に追加する。
- 解凍済みの全点を一度にメモリに載せない（**ストリーミング解凍**）。
- 実装: `decompressLAZWithLazPerfStreaming(arrayBuffer, header, centers, radius, ...)`（約1194行目）。
- 注意: 入力の圧縮ファイルは `lazFile.arrayBuffer()` で全体を読み込むため、1GB超LAZではその分のメモリは必要。

### 300MB以下

- 従来どおりファイル全体を読み込み、解凍またはパース後に `filterPointsBatchFast` でバッチフィルタ。
- 小さいファイル向けのシンプルな経路。

---

## 2. 他機能との比較（ポリゴンSIMA・ターゲット配置など）

| 機能 | 非圧縮LAS（300MB超） | 圧縮LAZ |
|------|----------------------|---------|
| 中心抽出 | チャンク読込 + マッチした点のみ保持 | ストリーミング解凍 + マッチした点のみ保持 |
| ポリゴン境界・ターゲット配置 | 同じチャンク読込（`processLASStreamingAllPoints`）で全点を蓄積 | 一括解凍 → 全点読み（ストリーミング解凍は未使用） |

- **非圧縮LAS**: ポリゴン・ターゲットでも300MB超の場合はチャンク読込を使用しており、読込は効率的。
- **圧縮LAZ**: ポリゴン・ターゲットでは「一括解凍 → 全点読み」のみ。中心抽出で使っているストリーミング解凍を共通化すると、大容量LAZでもメモリ効率を改善できる余地がある。

---

## 3. 今後の共通化候補

### ストリーミング解凍の共通化

- 解凍ループを1本にし、コールバック（例: `onPoint(point)`）で振る舞いを分ける。
  - 中心抽出: フィルタ条件を満たすときだけ push。
  - ポリゴン・ターゲット: 全点 push。
- ポリゴン・ターゲットでも解凍済みバッファを廃止し、メモリ効率を改善できる。

### ヘッダー読み込みの共通化

- `readLASHeaderFromFile(lazFile)` のような共通関数を1つ用意する。
- 立面図・縦断横断・ポリゴン・ターゲット・中心抽出の5箇所で利用し、修正・拡張を一括化する。

### 「LAZ/LAS を全点読み」の共通化

- ポリゴン・ターゲットで使う「全点が欲しい」経路を、`loadLAZAsPoints` / `loadLASAsPoints` のような共通関数にまとめる。
- ストリーミング解凍を共通化する際の受け口にもできる。

### その他

- `getStreamingOptions(lazFile)` で `fileSizeMB`, `useStreaming`, `chunkSizeMB` を返すヘルパーで、各処理の先頭の重複を削減できる。
- 未使用の `filterPointsBatch`（約1086行目）は、`filterPointsBatchFast` のみ使用のため整理または削除の検討余地あり。
